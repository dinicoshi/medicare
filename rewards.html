<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MediCare ‚Äì Rewards</title>
  <style>
    :root {
  --primary: #8e44ad; 
  --primary-light: #ca3bf6;
  --primary-dark: #a61dd8;
  --primary-gradient: linear-gradient(135deg, #bd25eb, #d13bf6);
  --secondary: #b60ee9;
  --accent: #9d06d4;

  --warning: #f59e0b;
  --danger: #dc2626;
  --success: #10b981;

  --light: #ffffff;
  --dark: #1e293b;
  --gray: #64748b;
  --gray-light: #f1f5f9;

  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 
             0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 
               0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 
               0 10px 10px -5px rgba(0, 0, 0, 0.04);

  --bg: var(--light);
  --card: #ffffff;
  --muted: var(--gray);
  --text: var(--dark);
  --ring: rgba(142, 68, 173, 0.3);
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  background: radial-gradient(1200px 600px at 85% -100px, rgba(142, 68, 173, .05), transparent),
              radial-gradient(900px 400px at -20% -120px, rgba(202, 59, 246, .05), transparent),
              linear-gradient(135deg, rgba(189, 37, 235, 0.04), rgba(209, 59, 246, 0.04));
  color: var(--text);
  min-height: 100vh;
}

header {
  background-color: #fff;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  position: sticky;
  top: 0;
  z-index: 100;
}

header .container {
  padding: 10px 20px;
}

header nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
}

.logo {
  display: flex;
  align-items: center;
  text-decoration: none;
  color: var(--dark);
  font-weight: bold;
  font-size: 1.5rem;
  margin-right: 30px;
}

.logo-icon {
  font-size: 1.8rem;
  color: var(--primary);
  margin-right: 8px;
}

.nav-links {
  display: flex;
  list-style: none;
  gap: 20px;
  margin: 0;
  padding: 0;
}

.nav-links a {
  text-decoration: none;
  color: var(--dark);
  font-weight: 500;
  transition: color 0.3s;
  position: relative;
  padding: 6px 0;
}

.nav-links a:hover {
  color: var(--primary);
}

.nav-links a.active {
  color: var(--primary);
}

.nav-links a.active::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: var(--primary);
  border-radius: 2px;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 20px;
  border-radius: var(--radius-md);
  font-weight: 600;
  font-size: 0.95rem;
  transition: all var(--transition-fast);
  cursor: pointer;
  letter-spacing: -0.2px;
  border: none;
  position: relative;
  overflow: hidden;
  z-index: 1;
}

.btn-primary {
  background: var(--primary-gradient);
  color: white;
  box-shadow: 0 4px 10px rgba(142, 68, 173, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(142, 68, 173, 0.4);
}

.btn-outline {
  background: transparent;
  border: 1px solid var(--primary);
  color: var(--primary);
}

.btn-outline:hover {
  background-color: rgba(142, 68, 173, 0.05);
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(142, 68, 173, 0.1);
}

.grid { display: grid; gap: 14px; }
.grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
@media (max-width:900px){.grid.cols-3{grid-template-columns:1fr;}}

.card {
  background: var(--card); border: 1px solid rgba(142,68,173,.15);
  border-radius: 16px; padding: 16px; box-shadow: var(--shadow-sm);
}
.card h3 { margin: 0 0 8px; }

.muted { color: var(--muted); }
.kpi { display: flex; align-items: center; justify-content: space-between; }
.points {
  font-size: 40px; font-weight: 800; letter-spacing: .5px;
  background: linear-gradient(90deg, var(--primary-light), var(--primary-dark));
  -webkit-background-clip: text; background-clip: text; color: transparent;
}

.progress { height: 10px; background: var(--gray-light); border-radius: 999px; overflow: hidden; border: 1px solid rgba(142,68,173,.15); }
.bar { height: 100%; width: 0%; background: var(--primary-gradient); }

.pill {
  display:inline-flex; align-items:center; gap:8px; 
  border:1px solid rgba(142,68,173,.2); border-radius:999px;
  padding:6px 10px; background:rgba(142,68,173,.08); color: var(--primary-dark);
}

.list { display:flex; flex-direction:column; gap:10px; }
.item {
  display:flex; justify-content:space-between; align-items:center; gap:12px;
  padding:12px; border:1px solid rgba(142,68,173,.12); background:var(--gray-light); border-radius:12px;
}
.item .meta { display:flex; align-items:center; gap:10px; }

.badge {
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 12px; border-radius:12px;
  background:linear-gradient(180deg, rgba(142,68,173,.1), rgba(142,68,173,.05));
  border:1px solid rgba(142,68,173,.2); color: var(--primary-dark);
}
.badge.locked { opacity:.6; filter:grayscale(80%); }

.tabs { display:flex; gap:8px; flex-wrap:wrap; }
.tab {
  padding:10px 12px; border-radius:12px; border:1px solid rgba(142,68,173,.2);
  background:var(--gray-light); color:var(--muted); cursor:pointer;
}
.tab.active { color: var(--primary-dark); background: rgba(142,68,173,.15); }

.hidden { display:none !important; }
.success { color: var(--success); }
.warn { color: var(--warning); }
.danger { color: var(--danger); }
.small { font-size: 12px; }

.input {
  width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(142,68,173,.2);
  background: var(--light); color: var(--dark);
}
.inline { display:flex; gap:8px; align-items:center; }
.grow { flex:1; }
.center { display:flex; align-items:center; justify-content:center; }


  </style>
</head>
<body>
<header>
  <div class="container">
    <nav>
      <a href="healthindex.html" class="logo">
        <span class="logo-icon">üß¨</span><span class="logo-text">MediCare</span>
      </a>
      <ul class="nav-links">
        <li><a href="healthindex.html">Home</a></li>
        <li><a href="finder.html">Pharmacy Finder</a></li>
        <li><a href="calendar.html">Calendar</a></li>
        <li><a class="active" href="rewards.html">Rewards</a></li>
      </ul>
      <div class="auth-area">
        <button class="btn btn-outline" onclick="window.location.href='healthindex.html?action=login'">Sign In</button>
        <button class="btn btn-primary" onclick="window.location.href='healthindex.html?action=signup'">Sign Up</button>
      </div>
    </nav>
  </div>
</header>

<main class="container" style="padding:22px 20px 60px">
  <section class="grid cols-3" style="margin-bottom:14px">
    <div class="card">
      <div class="kpi">
        <div>
          <h3>Total Points</h3>
          <div class="muted small">Earn points for healthy actions.</div>
        </div>
        <span class="pill"><span>üî•</span><strong id="streak-days">0</strong>-day streak</span>
      </div>
      <div class="points" id="points">0</div>
      <div class="muted small" id="level-label">Level 1 ‚Ä¢ Beginner</div>
      <div style="margin-top:10px">
        <div class="progress"><div class="bar" id="level-progress"></div></div>
      </div>
      <div class="inline" style="margin-top:12px">
        <button class="btn primary" onclick="quickDailyLog()">+ Quick Daily Log</button>
        <button class="btn" onclick="openTab('challenges')">View Challenges</button>
      </div>
    </div>

    <div class="card">
      <h3>Today‚Äôs Checklist</h3>
      <div class="list" id="today-checklist"></div>
      <div class="inline small muted" style="margin-top:8px">
        <span>Tip: completing all items grants a bonus ‚≠ê</span>
      </div>
    </div>

    <div class="card">
      <h3>Badges</h3>
      <div class="inline" style="gap:8px; flex-wrap:wrap" id="badges"></div>
      <div class="muted small" style="margin-top:8px">Unlock badges by hitting milestones.</div>
    </div>
  </section>

  <section class="card">
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="dashboard" onclick="openTab('dashboard')">Dashboard</button>
      <button class="tab" data-tab="challenges" onclick="openTab('challenges')">Challenges</button>
      <button class="tab" data-tab="leaderboard" onclick="openTab('leaderboard')">Leaderboard</button>
      <button class="tab" data-tab="settings" onclick="openTab('settings')">Settings</button>
    </div>

    <!-- DASHBOARD -->
    <div id="panel-dashboard" style="margin-top:12px">
      <div class="grid cols-3">
        <div class="card">
          <h3>Daily Log</h3>
          <div class="list">
            <div class="item">
              <div class="meta"><span>üíß</span><div>Water Intake</div></div>
              <div class="inline">
                <input id="water-ml" class="input" type="number" placeholder="ml (e.g., 500)" style="width:130px">
                <button class="btn" onclick="logAction('water')">Log</button>
              </div>
            </div>
            <div class="item">
              <div class="meta"><span>üö∂</span><div>Steps</div></div>
              <div class="inline">
                <input id="steps" class="input" type="number" placeholder="e.g., 3000" style="width:130px">
                <button class="btn" onclick="logAction('steps')">Log</button>
              </div>
            </div>
            <div class="item">
              <div class="meta"><span>üõèÔ∏è</span><div>Sleep (hours)</div></div>
              <div class="inline">
                <input id="sleep" class="input" type="number" step="0.1" placeholder="e.g., 7.5" style="width:130px">
                <button class="btn" onclick="logAction('sleep')">Log</button>
              </div>
            </div>
            <div class="item">
              <div class="meta"><span>üìù</span><div>Symptoms Logged</div></div>
              <button class="btn" onclick="logAction('symptoms')">Mark Done</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Recent Activity</h3>
          <div id="activity" class="list"></div>
        </div>

        <div class="card">
          <h3>How to Earn</h3>
          <ul class="muted" style="margin:0 0 6px 16px">
            <li>Mark a medication as taken: <strong>+10</strong></li>
            <li>Complete all daily items: <strong>+15 bonus</strong></li>
            <li>Water / Steps / Sleep / Symptoms: <strong>+3‚Äì8 each</strong></li>
            <li>Maintain streak: <strong>+2 per day</strong> after 3 days</li>
          </ul>
          <div class="small muted">Medication points are auto-awarded when you complete reminders on the Calendar/Reminders page.</div>
        </div>
      </div>
    </div>

    <!-- CHALLENGES -->
    <div id="panel-challenges" class="hidden" style="margin-top:12px">
      <div class="grid cols-3">
        <div class="card">
          <h3>Daily Challenges</h3>
          <div id="challenges-list" class="list"></div>
          <div class="inline" style="margin-top:8px">
            <button class="btn" onclick="refreshChallenges()">Refresh</button>
          </div>
        </div>
        <div class="card">
          <h3>Weekly Goals</h3>
          <div class="list" id="weekly-goals"></div>
        </div>
        <div class="card">
          <h3>Bonus Quests</h3>
          <div class="list" id="bonus-quests"></div>
        </div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div id="panel-leaderboard" class="hidden" style="margin-top:12px">
      <div class="grid cols-3">
        <div class="card" style="grid-column:1 / -1">
          <h3>Local Leaderboard</h3>
          <div class="list" id="leaderboard"></div>
          <div class="inline" style="margin-top:8px">
            <input id="lb-name" class="input grow" placeholder="Enter your display name"/>
            <button class="btn" onclick="saveLeaderboardName()">Save Name</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="panel-settings" class="hidden" style="margin-top:12px">
      <div class="grid cols-3">
        <div class="card">
          <h3>Rewards Settings</h3>
          <div class="list">
            <div class="item">
              <div class="meta"><strong>Daily Bonus</strong><div class="small muted">Add small streak bonus after day 3</div></div>
              <label class="inline"><input id="set-streak-bonus" type="checkbox" /> <span>Enable</span></label>
            </div>
            <div class="item">
              <div class="meta"><strong>Reset All</strong><div class="small muted">Clear points, streaks, badges</div></div>
              <button class="btn danger" onclick="resetAll()">Reset</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Export</h3>
          <div class="list">
            <div class="item">
              <div class="meta"><span>üìÑ</span><div>Export rewards data (JSON)</div></div>
              <button class="btn" onclick="exportData()">Download</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>About</h3>
          <div class="muted small">
            MediCare Rewards is for motivation only and not a health assessment tool. Medical concerns? Please seek professional care.
          </div>
        </div>
      </div>
    </div>

  </section>
</main>

<script>
/* ========== STORAGE KEYS ========== */
const KEY = {
  points: 'ms_points',
  activity: 'ms_activity',
  streak: 'ms_streak',
  lastLog: 'ms_last_log_date',
  badges: 'ms_badges',
  challenges: 'ms_challenges',
  settings: 'ms_rewards_settings',
  leaderboard: 'ms_leaderboard'
};

/* ========== STATE HELPERS ========== */
const todayStr = () => new Date().toISOString().slice(0,10);
const load = (k, def) => JSON.parse(localStorage.getItem(k) || JSON.stringify(def));
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

/* ========== INITIALIZE ========== */
let points = load(KEY.points, 0);
let activity = load(KEY.activity, []);          // [{ts, text, delta}]
let streak = load(KEY.streak, 0);
let lastLog = load(KEY.lastLog, null);
let badges = load(KEY.badges, {});              // {badgeId: true}
let challenges = load(KEY.challenges, {});      // {date, dailies:[...], done:{id:true}}
let settings = load(KEY.settings, {streakBonus:true});
let leaderboard = load(KEY.leaderboard, {name:'You', entries:[]});

/* ========== LEVELS ========== */
const levelBreaks = [0, 100, 250, 450, 700, 1000, 1400, 1850, 2350, 2900]; // expand as needed
function currentLevel(p=points){
  for(let i=levelBreaks.length-1;i>=0;i--) if(p>=levelBreaks[i]) return i+1;
  return 1;
}
function levelProgress(p=points){
  const lvl = currentLevel(p);
  const start = levelBreaks[lvl-1] || 0;
  const end   = levelBreaks[lvl] || (start+300);
  const pct = Math.max(0, Math.min(100, Math.round( ( (p-start)/(end-start) )*100 )));
  return {lvl, pct};
}

/* ========== BADGES ========== */
const ALL_BADGES = [
  {id:'p100', label:'100 Points', icon:'üèÖ', rule: s=>points>=100},
  {id:'p500', label:'500 Points', icon:'ü•á', rule: s=>points>=500},
  {id:'streak3', label:'3-Day Streak', icon:'üî•', rule: s=>streak>=3},
  {id:'streak7', label:'7-Day Streak', icon:'‚ö°', rule: s=>streak>=7},
  {id:'checklist10', label:'10 Checklists', icon:'‚úÖ', rule: s=> (activity.filter(a=>/Checklist bonus/.test(a.text))).length>=10},
  {id:'med10', label:'10 Meds Taken', icon:'üíä', rule: s=>{
    const hist = load('medicationHistory', []);
    return hist.filter(h=>h.status==='taken').length>=10;
  }},
];

/* ========== CHALLENGES ========== */
const DEFAULT_DAILIES = () => ([
  {id:'daily-water', text:'Drink at least 1500 ml of water', reward:8, done:false},
  {id:'daily-steps', text:'Walk 3000+ steps', reward:8, done:false},
  {id:'daily-sleep', text:'Sleep 7+ hours (last night)', reward:8, done:false},
  {id:'daily-symptom', text:'Log today‚Äôs symptoms', reward:6, done:false},
  {id:'daily-meds', text:'Mark a medication as taken', reward:10, done:false}
]);
function ensureTodayChallenges(){
  if(challenges.date !== todayStr()){
    challenges = {date: todayStr(), dailies: DEFAULT_DAILIES(), done:{}};
    save(KEY.challenges, challenges);
  }
}

/* ========== POINTS & ACTIVITY ========== */
function award(pts, text){
  points += pts;
  save(KEY.points, points);
  activity.unshift({ts: Date.now(), text, delta: pts});
  activity = activity.slice(0, 80);
  save(KEY.activity, activity);
  tickStreak();
  updateBadges();
  renderAll();
}
function tickStreak(){
  const today = todayStr();
  if(lastLog === today){ return; }
  const y = new Date(); y.setDate(y.getDate()-1);
  const yesterday = y.toISOString().slice(0,10);
  if(lastLog === yesterday) streak += 1;
  else streak = 1;
  lastLog = today;
  save(KEY.streak, streak);
  save(KEY.lastLog, lastLog);
  if(settings.streakBonus && streak>=3) award(2, `Streak bonus (Day ${streak})`);
}

/* ========== CHECKLIST / QUICK LOG ========== */
function getDailyState(){
  const key = 'ms_daily_'+todayStr();
  return load(key, {water:false, steps:false, sleep:false, symptoms:false, meds:false});
}
function setDailyState(update){
  const key = 'ms_daily_'+todayStr();
  const curr = getDailyState();
  const next = {...curr, ...update};
  save(key, next);
  // if all complete ‚Üí bonus
  const allDone = ['water','steps','sleep','symptoms','meds'].every(k=>next[k]);
  const wasDone = ['water','steps','sleep','symptoms','meds'].every(k=>curr[k]);
  if(allDone && !wasDone){
    award(15, 'Checklist bonus ‚Äì All daily items complete');
  }
  renderChecklist();
}
function quickDailyLog(){
  logAction('water'); logAction('steps'); logAction('sleep'); logAction('symptoms');
}

/* ========== LOGGING ACTIONS ========== */
function logAction(type){
  let value = null, rewarded = 0, label = '';
  if(type==='water'){
    value = parseInt(document.getElementById('water-ml').value||'0',10);
    if(value>0){ rewarded = value>=1500 ? 8 : 4; label = `Water logged: ${value} ml`; setDailyState({water:true}); markChallenge('daily-water'); }
    else return alert('Enter water in ml');
  }
  if(type==='steps'){
    value = parseInt(document.getElementById('steps').value||'0',10);
    if(value>0){ rewarded = value>=3000 ? 8 : 4; label = `Steps logged: ${value}`; setDailyState({steps:true}); markChallenge('daily-steps'); }
    else return alert('Enter steps');
  }
  if(type==='sleep'){
    value = parseFloat(document.getElementById('sleep').value||'0');
    if(value>0){ rewarded = value>=7 ? 8 : 4; label = `Sleep logged: ${value} hrs`; setDailyState({sleep:true}); markChallenge('daily-sleep'); }
    else return alert('Enter sleep hours');
  }
  if(type==='symptoms'){
    rewarded = 6; label = 'Symptoms logged'; setDailyState({symptoms:true}); markChallenge('daily-symptom');
  }
  if(rewarded>0){
    award(rewarded, label);
  }
}

/* ========== CHALLENGE STATUS ========== */
function markChallenge(id){
  ensureTodayChallenges();
  const found = challenges.dailies.find(c=>c.id===id);
  if(found && !found.done){
    found.done = true;
    challenges.done[id] = true;
    save(KEY.challenges, challenges);
    award(found.reward, `Challenge: ${found.text}`);
  }
  renderChallenges();
}

/* ========== MEDICATION INTEGRATION ========== */
/* Listens for changes from other pages (e.g., marking a reminder as taken).
   Expects 'medicationHistory' array to grow; awards points for today's 'taken'. */
let lastMedCount = (load('medicationHistory', [])||[]).length;
window.addEventListener('storage', (e)=>{
  if(e.key==='medicationHistory'){
    try{
      const hist = JSON.parse(e.newValue||'[]');
      if(hist.length > lastMedCount){
        const latest = hist[0] || hist[hist.length-1];
        if(latest && latest.status==='taken'){
          const dt = new Date(latest.time);
          const isToday = dt.toISOString().slice(0,10) === todayStr();
          if(isToday){
            setDailyState({meds:true});
            markChallenge('daily-meds');
            award(10, `Medication taken: ${latest.name} ${latest.dosage}`);
          }
        }
      }
      lastMedCount = hist.length;
    }catch(_){}
  }
});

/* ========== RENDERERS ========== */
function renderHeader(){
  document.getElementById('points').textContent = points;
  document.getElementById('streak-days').textContent = streak || 0;
  const {lvl, pct} = levelProgress(points);
  document.getElementById('level-label').textContent = `Level ${lvl} ‚Ä¢ ${lvl===1?'Beginner':'Healthy Journey'}`;
  document.getElementById('level-progress').style.width = pct + '%';
}
function renderActivity(){
  const box = document.getElementById('activity');
  box.innerHTML = '';
  if(activity.length===0){ box.innerHTML = `<div class="muted small">No activity yet.</div>`; return; }
  activity.slice(0,10).forEach(a=>{
    const d = new Date(a.ts);
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class="meta"><span>‚ûï</span><div>${a.text}</div></div>
      <div><strong>+${a.delta}</strong> <span class="small muted">‚Ä¢ ${d.toLocaleTimeString()}</span></div>`;
    box.appendChild(row);
  });
}
function renderChecklist(){
  const t = getDailyState();
  const el = document.getElementById('today-checklist');
  el.innerHTML = '';
  const rows = [
    {k:'water', label:'Water 1500 ml', icon:'üíß'},
    {k:'steps', label:'Walk 3000 steps', icon:'üö∂'},
    {k:'sleep', label:'Sleep 7+ hours', icon:'üõèÔ∏è'},
    {k:'symptoms', label:'Log symptoms', icon:'üìù'},
    {k:'meds', label:'Take medication', icon:'üíä'},
  ];
  rows.forEach(r=>{
    const item = document.createElement('div'); item.className='item';
    item.innerHTML = `<div class="meta"><span>${r.icon}</span><div>${r.label}</div></div>
      <div>${t[r.k] ? '‚úÖ Completed' : '<button class="btn" onclick="manualComplete(\''+r.k+'\')">Mark</button>'}</div>`;
    el.appendChild(item);
  });
}
function manualComplete(k){
  if(k==='meds'){
    // user can manually mark if they didn't come from calendar page
    award(6, 'Medication task marked complete');
    markChallenge('daily-meds');
  }
  setDailyState({[k]:true});
}
function renderBadges(){
  const box = document.getElementById('badges');
  box.innerHTML='';
  ALL_BADGES.forEach(b=>{
    const unlocked = !!badges[b.id];
    const el = document.createElement('div');
    el.className = 'badge ' + (unlocked?'':'locked');
    el.innerHTML = `<span>${b.icon}</span><div>${b.label}</div>`;
    box.appendChild(el);
  });
}
function updateBadges(){
  let changed=false;
  ALL_BADGES.forEach(b=>{
    if(b.rule() && !badges[b.id]){ badges[b.id]=true; changed=true; activity.unshift({ts:Date.now(), text:`Badge unlocked: ${b.label}`, delta: 0}); }
  });
  if(changed){ save(KEY.badges, badges); renderBadges(); renderActivity(); }
}
function renderChallenges(){
  ensureTodayChallenges();
  const wrap = document.getElementById('challenges-list');
  wrap.innerHTML='';
  challenges.dailies.forEach(c=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `<div class="meta"><span>${c.done?'üèÅ':'üéØ'}</span><div>${c.text}</div></div>
                     <div>${c.done?'<span class="success">Done</span>':'<button class="btn" onclick="markChallenge(\''+c.id+'\')">Complete +'+c.reward+'</button>'}</div>`;
    wrap.appendChild(row);
  });

  // Weekly goals (simple summary)
  const weekly = document.getElementById('weekly-goals');
  weekly.innerHTML='';
  const hist = activity.filter(a=>Date.now()-a.ts<7*24*3600*1000);
  const completed = hist.filter(a=>/Challenge:/.test(a.text)).length;
  const w = document.createElement('div'); w.className='item';
  w.innerHTML = `<div class="meta"><span>üìÜ</span><div>Complete 15 challenges this week</div></div>
                 <div>${completed}/15</div>`;
  weekly.appendChild(w);

  // Bonus quests
  const bonus = document.getElementById('bonus-quests');
  bonus.innerHTML='';
  const q = document.createElement('div'); q.className='item';
  q.innerHTML = `<div class="meta"><span>‚≠ê</span><div>Hit a 3-day streak</div></div>
                 <div>${streak>=3?'<span class="success">Achieved</span>':'<span class="warn">In progress</span>'}</div>`;
  bonus.appendChild(q);
}
function renderLeaderboard(){
  const box = document.getElementById('leaderboard');
  // ensure current user in entries
  const me = leaderboard.name || 'You';
  const entries = leaderboard.entries || [];
  const existing = entries.find(e=>e.name===me);
  if(!existing){ entries.push({name:me, points}); }
  else existing.points = points;
  // fake NPCs for demo
  const baseline = [
    {name:'Alex', points: 420},
    {name:'Jordan', points: 690},
    {name:'Casey', points: 250}
  ];
  const merged = [...entries, ...baseline].reduce((map, e)=>{ map.set(e.name, Math.max(map.get(e.name)||0, e.points)); return map; }, new Map());
  const table = Array.from(merged.entries()).map(([name, pts])=>({name, points: pts})).sort((a,b)=>b.points-a.points).slice(0,10);
  box.innerHTML = '';
  table.forEach((row, idx)=>{
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div class="meta"><strong>#${idx+1}</strong><div>${row.name}</div></div><div><strong>${row.points}</strong></div>`;
    box.appendChild(el);
  });
  leaderboard.entries = table.filter(e=>e.name!==me);
  save(KEY.leaderboard, leaderboard);
}

/* ========== TABS ========== */
function openTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
  ['dashboard','challenges','leaderboard','settings'].forEach(p=>{
    document.getElementById('panel-'+p).classList.toggle('hidden', p!==name);
  });
}

/* ========== SETTINGS / UTILS ========== */
function saveLeaderboardName(){
  const v = (document.getElementById('lb-name').value || '').trim();
  if(!v) return alert('Enter a name');
  leaderboard.name = v;
  save(KEY.leaderboard, leaderboard);
  renderLeaderboard();
}
function refreshChallenges(){
  challenges = {date: todayStr(), dailies: DEFAULT_DAILIES(), done:{}};
  save(KEY.challenges, challenges);
  renderChallenges();
}
function resetAll(){
  if(!confirm('This will clear your rewards data. Continue?')) return;
  points = 0; activity=[]; streak=0; lastLog=null; badges={}; challenges={}; leaderboard={name:'You', entries:[]};
  save(KEY.points, points); save(KEY.activity, activity); save(KEY.streak, streak); save(KEY.lastLog, lastLog);
  save(KEY.badges, badges); save(KEY.challenges, challenges); save(KEY.leaderboard, leaderboard);
  renderAll();
}
function exportData(){
  const blob = new Blob([JSON.stringify({
    points, activity, streak, lastLog, badges, challenges, leaderboard
  }, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='medicare_rewards.json'; a.click();
  URL.revokeObjectURL(url);
}

/* ========== RENDER ALL ========== */
function renderAll(){
  renderHeader();
  renderChecklist();
  renderActivity();
  renderBadges();
  renderChallenges();
  renderLeaderboard();
  // reflect settings
  document.getElementById('set-streak-bonus').checked = !!settings.streakBonus;
}

/* ========== INIT ========== */
(function init(){
  ensureTodayChallenges();
  document.getElementById('lb-name').value = leaderboard.name || '';
  document.getElementById('set-streak-bonus').addEventListener('change', e=>{
    settings.streakBonus = e.target.checked; save(KEY.settings, settings);
  });
  renderAll();
})();
</script>
</body>
</html>
